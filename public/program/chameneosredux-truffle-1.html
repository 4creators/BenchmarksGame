<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>chameneos-redux Ruby Truffle program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding: 0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans,Ubuntu,Verdana,sans-serif;margin:0;-webkit-text-size-adjust:100%}h1,h2,h3,li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h1{font-size:1.4em;font-weight:bold;margin:0;padding:.4em}h1,h1 a{color:white}h1 small{font-size:0.64em}h2,h3{margin:1.5em 0 0}h2{font-size:1.4em;font-weight:normal}h3{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin:.5em .5em 0;padding:.5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin:.3em 0 0}p a,a span{border-bottom:.1em solid #333;padding-bottom:.1em}#u64,#u64q{background-color:#dd4814}#u32{background-color:#ffb515}#u32q{background-color:#ff6309}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width:60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="./favicon.ico">
<header id="top">
  <h1 id="u64q"><a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/">The&nbsp;<small>Computer&nbsp;Language</small><br>Benchmarks&nbsp;Game</a></h1>
</header>
<article>
  <div>
    <h2>chameneos-redux Ruby Truffle program</h2>
    <aside>
      <p><a href="../description/chameneosredux.html#chameneosredux">description</a>
    </aside>
  </div>
  <section>
    </div>
      <h3>source code</h3>
    </div>
    <pre>
# The Computer Language Benchmarks Game
# http://benchmarksgame.alioth.debian.org/

#   contributed by Michael Barker
#   based on a Java contribution by Luzius Meisser
#   converted to C by dualamd
#   converted to Ruby by Eugene Pimenov

#require &apos;thread&apos;

COLORS     = [:blue, :red, :yellow, :invalid].freeze
COMPLIMENT = {
  :blue =&gt; {:blue =&gt; :blue, :red =&gt; :yellow, :yellow =&gt; :red}.freeze,
  :red =&gt; {:blue =&gt; :yellow, :red =&gt; :red, :yellow =&gt; :blue}.freeze,
  :yellow =&gt; {:blue =&gt; :red, :red =&gt; :blue, :yellow =&gt; :yellow}.freeze
}.freeze

$creature_id = 0

NUMBERS = %w{zero one two three four five six seven eight nine}.freeze

# convert integer to number string: 1234 -&gt; &quot;one two three four&quot;
def format_number(num)
  out = []
  begin
    out &lt;&lt; NUMBERS[num%10]
    num /= 10
  end while num &gt; 0
  out.reverse.join(&quot; &quot;)
end

class MeetingPlace
  attr_reader :mutex
  attr_accessor :meetings_left, :first_creature

  def initialize(meetings)
    &#64;mutex = Mutex.new
    &#64;meetings_left = meetings
  end
end

class Creature
  attr_accessor :place, :thread, :count, :same_count, :color, :id, :two_met, :sameid

  def initialize(place, color)
    &#64;place = place
    &#64;count = &#64;same_count = 0

    &#64;id = ($creature_id += 1)
    &#64;color = color
    &#64;two_met = FALSE

    &#64;thread = Thread.new do
      loop do
        if meet
          Thread.pass while &#64;two_met == false

          &#64;same_count += 1 if &#64;sameid
          &#64;count += 1
        else
          break
        end
      end
    end
  end

  def meet
    &#64;place.mutex.lock

    if &#64;place.meetings_left &gt; 0
      if &#64;place.first_creature
        first = &#64;place.first_creature
        new_color = COMPLIMENT[&#64;color][first.color]

        &#64;sameid  = first.sameid  = &#64;id == first.id
        &#64;color   = first.color   = new_color
        &#64;two_met = first.two_met = true

        &#64;place.first_creature = nil
        &#64;place.meetings_left -= 1
      else
        &#64;two_met = false
        &#64;place.first_creature = self
      end
      true
    else
      false
    end
  ensure
    &#64;place.mutex.unlock
  end

  def result
    &apos;&apos; &lt;&lt; &#64;count.to_s &lt;&lt; &apos; &apos; &lt;&lt; format_number(&#64;same_count)
  end
end

def run_game(n_meeting, colors)
  place = MeetingPlace.new(n_meeting)

  creatures = []
  colors.each do |color|
    print color, &quot; &quot;
    creatures &lt;&lt; Creature.new(place, color)
  end
  puts

  # wait for them to meet
  creatures.each { |c| c.thread.join}

  total = 0
  # print meeting times of each creature
  creatures.each do |c|
    puts c.result
    total += c.count
  end

  # print total meeting times, should be equal n_meeting
  print &apos; &apos;, format_number(total), &quot;\n\n&quot;
end

def print_colors_table
  [:blue, :red, :yellow].each do |c1|
    [:blue, :red, :yellow].each do |c2|
      puts &quot;#{c1} + #{c2} -&gt; #{COMPLIMENT[c1][c2]}&quot;
    end
  end
end

n = (ARGV[0] || 600).to_i


print_colors_table
puts

run_game n, [:blue, :red, :yellow]
run_game n, [:blue, :red, :yellow, :red, :yellow, :blue, :red, :yellow, :red, :blue]
    </pre>
  </section>
  <section>
    <h3 id="log">notes, command-line, and program output</h3>
    <pre>
NOTES:
64-bit Ubuntu quad core
truffleruby 1.0.0-rc1, like ruby 2.3.7  [x86_64-linux]


Sat, 21 Apr 2018 00:42:00 GMT

COMMAND LINE:
/opt/src/graalvm-ce-1.0.0-rc1-linux-amd64/graalvm-1.0.0-rc1/bin/truffleruby --jvm -W0 chameneosredux.truffle 6000000

PROGRAM OUTPUT:
blue + blue -&gt; blue
blue + red -&gt; yellow
blue + yellow -&gt; red
red + blue -&gt; yellow
red + red -&gt; red
red + yellow -&gt; blue
yellow + blue -&gt; red
yellow + red -&gt; blue
yellow + yellow -&gt; yellow

blue red yellow 
3954587 zero
3706496 zero
4338917 zero
 one two zero zero zero zero zero zero

blue red yellow red yellow blue red yellow red blue 
1112946 zero
1230822 zero
1080229 zero
1256968 zero
1239463 zero
1306050 zero
1298815 zero
1124837 zero
1217235 zero
1132635 zero
 one two zero zero zero zero zero zero

    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="../license.html"><span>license</span></a>
    </ul>
  </nav>
</footer>

